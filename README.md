# gcp_poc_oss_llm_project

## **1\. 概要**

### **1.1. 目的**

GCPのCompute Engine (GCE) とSpot VMを直接利用し、インフラやLLM周辺の知見を深めながら、ガバナンスの効いた**データの整合性が担保された**セキュアかつ低コストなクローズドLLMサービスを構築する。

### **1.2. 基本要件**

* **インフラ:** GCE \+ GPU付きSpot VM を手動で構成  
* **ネットワーク:** VPCによるクローズドな環境  
* **認証:** OIDC (IAPを利用) による特定ユーザーへのアクセス制御  
* **ガバナンス:** 承認されたユーザーのみがプロンプト経由でドキュメントを更新可能  
* **データ整合性:** **マスタードキュメント(GCS)とベクトルDBの同期を保証する**

## **2\. ヒアリング事項 (確定済み)**

* **ユースケース:** 社内ドキュメント要約チャットボット（＋動的更新機能）  
* **ユーザー数:** 10人程度  
* **パフォーマンス:** 低レイテンシー重視  
* **LLMモデル:** Llama 3.1 8B  
* **クラウド:** GCP  
* **コンテナ:** 経験あり

## **3\. アーキテクチャ案 (最終版)**

インフラの学習効果、コスト効率、厳格なガバナンス、そしてデータの整合性をすべて満たす構成です。

\[構成図\]  
上図のフロー: ユーザーはIAPで認証され、APIにアクセス。更新指示の場合、権限チェックを経てPub/Subにタスクが送られ、非同期ワーカーがGCS上のマスターファイルとベクトルDBの両方を更新する。

### **3.1. 構成要素とGCPサービス**

(構成要素は変更ありません)

1. **認証とアクセス入口:** Cloud Load Balancing \+ Identity-Aware Proxy (IAP)  
2. **推論・アプリケーション実行環境:** Compute Engine (GCE) \+ Managed Instance Group (MIG)  
3. **非同期タスクキュー:** Cloud Pub/Sub  
4. **ベクトルDB & ドキュメント管理:**  
   * **ベクトルDB:** Cloud SQL for PostgreSQL \+ pgvector拡張  
   * **マスタードキュメント保管:** Google Cloud Storage (GCS)  
   * **バッチ更新:** Cloud Functions \+ Cloud Scheduler

### **3.2. 動的更新とガバナンスのフロー**

ユーザーのプロンプトによる動的ドキュメント更新は、以下の厳格なフローで実行されます。

1. 意図判別 (APIサーバー):  
   ユーザーからのプロンプトをLLMで分析し、「質問」か「更新指示」かを判別します。  
2. 権限検証 (APIサーバー):  
   「更新指示」の場合、IAPから受け取ったユーザーIDを検証し、\*\*「ドキュメント更新権限を持つユーザー」\*\*かを確認します。権限がなければここで処理を中断します。  
3. タスク発行 (APIサーバー):  
   権限がある場合のみ、更新内容をメッセージとしてPub/Subに発行し、ユーザーには即座に応答します。  
4. 非同期更新処理 (更新ワーカー):  
   GCE上で待機している更新ワーカーがPub/Subからタスクを受け取り、以下の処理を順次実行します。  
   a. LLMで指示内容を構造化データとして抽出します。  
   b. ベクトルDBを検索し、更新対象のチャンクとその元となったマスターファイル名を特定します。  
   c. LLMを使い、新しい内容を反映した文章を生成します。  
   d. 【マスター更新】: GCSからマスターファイルをダウンロードし、該当部分を新しい文章に書き換えて、GCSに上書き保存します。  
   e. 【DB更新】: 新しい文章のベクトルを計算し、Cloud SQL (ベクトルDB) のレコードを更新します。

## **4\. この構成のメリット**

* **学習効果:** GCE, MIG, VPC, Pub/SubといったGCPのコアサービスを深く理解できます。  
* **コスト効率:** MIGとSpot VMの組み合わせでGPUコストを大幅に削減します。  
* **高いセキュリティとガバナンス:** IAPによる堅牢な認証と、操作権限の分離により、システムの安全性を確保します。  
* **システムの安定性と応答性:** Pub/Subを介した非同期処理により、重い更新タスクがチャットボットのパフォーマンスに影響を与えることはありません。  
* **【重要】データの整合性と永続性:** **マスタードキュメントとベクトルDBが常に同期される**ため、データの不整合を防ぎ、ユーザーによる更新が永続的に保持されます。これにより、システムの信頼性と保守性が大幅に向上します。
